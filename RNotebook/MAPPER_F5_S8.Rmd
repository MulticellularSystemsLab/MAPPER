---
title: |
  | MAPPER Data Notebook
  | Summer 2021
author: | 
  | Francisco Huizar and Nilay Kumar
  | University of Notre Dame
  | Department of Chemical and Biomolecular Engineering
  | Bioengineering Ph.D. Program, 4th year
  |
  | ![](Resources/titlePage.png){width=400px}
  |
output:
  html_document:
    keep_md: yes
    df_print: paged
    toc: yes
  html_notebook:
    df_print: paged
    toc: yes
    toc_float: yes
---

# R setup and necessary packages for this code

Below are the function calls to setup the workspace and load packages necessary to run this script. 

```{r setup, message=FALSE, warning=FALSE, error=FALSE}
rm(list=ls()) # Clear workspace
par(mfrow=c(1,1)) # Setup plot parameters
par(ps = 12, font.lab = 1) # Plot parameters
set.seed(1) # set random seed generator for reproducibility
knitr::opts_chunk$set(dev = c("svg"),
                      dpi = 300,
                      fig.path="MAPPER_Replicated_Figures/",
                      cache = TRUE,
                      comment = NA)
library(tidyverse)
```

<p style="page-break-before: always">

# Data import and pre-process

## Load the data

Load the data from the CSV file for wing measurements.

```{r dataLoading, message=FALSE, warning=FALSE, error=FALSE}
dataset_df = read.csv("MAPPER_Data_New.csv", header=T, sep=",") %>% tibble()
grouped_by_species = group_by(dataset_df, Species)
grouped_by_species
```

## Function for 95% median CI

Below is a function that calculates the exact confidence interval for a median from the DescTools package SignTest.default. The confidence interval is a non-parametric interval for the median using order statistics to deal directly with error on the median. More information can be found at http://www.stat.umn.edu/geyer/old03/5102/notes/rank.pdf and http://de.scribd.com/doc/75941305/Confidence-Interval-for-Median-Based-on-Sign-Test

```{r CI_Median}
cimed <- function(x, alpha=0.05, na.rm=FALSE) {
  if(na.rm) x <- x[! is.na(x)]
  n <- length(x)
  k <- qbinom(p=alpha / 2, size=n, prob=0.5, lower.tail=TRUE)
  ## Actual CL: 1 - 2 * pbinom(k - 1, size=n, prob=0.5) >= 1 - alpha
  sort(x)[c(k, n - k + 1)]
}
```


# Generate Plots for Figure 5

## Figure 5B

Plotted is the total wing area for males and females (in $mm^2$) of the tested $\textit{Drosophila}$ species.

```{r Figure_5B}
plot_widths = 5.75
plot_heights = 3.25
plot_order = c("DMF","DMM","DSF","DSM","DAF","DAM","DVF","DVM")
#svg("Total_Area.svg", width = plot_widths, height = plot_heights, family="arial")

ggplot(grouped_by_species %>% dplyr::filter(Metric=="Area"),
       aes(x=factor(Species_Gender, ordered=TRUE, levels = plot_order),
           y=Measure,
           fill=Gender)) +
  geom_violin(scale="width", alpha=0.50) +
  geom_jitter(width=0.25) +
  stat_summary(fun="median", geom="crossbar", size=0.5, fill="red", color = "blue") +
  stat_summary(fun="cimed", geom="crossbar", size=0.5, fill="red", color = "red") +

  #theme(axis.text.x = element_text(angle = 45, vjust = 0.6),
  #      axis.title.x=element_blank(),
  #      axis.title.y=element_blank()) +
  
  theme(axis.text.x = element_text(angle = 45, vjust = 0.6),
        axis.title.x=element_blank()) +
  
  
  labs(x=expression(paste("")), y=expression(paste("Total wing area " (mm^2)))) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))
```

## Figure 5C

Plotted is the quantification of shift in posterior cross vein position for males and females of the tested $\textit{Drosophila}$ species ($d_1$ is defined as the segment of $L_5$ from the proximal end of the vein to posterior cross vein, $d_2$ is defined as the segment of $L_5$ from the posterior cross vein to the distal end of $L_5$).

```{r Figure_5C}
plot_widths = 5.75
plot_heights = 3.25
plot_order = c("DMF","DMM","DSF","DSM","DAF","DAM","DVF","DVM")
#svg("Total_Area.svg", width = plot_widths, height = plot_heights, family="arial")

ggplot(grouped_by_species %>% dplyr::filter(Metric=="d1d2"),
       aes(x=factor(Species_Gender, ordered=TRUE, levels = plot_order),
           y=Measure,
           fill=Gender)) +
  geom_violin(scale="width", alpha=0.50) +
  geom_jitter(width=0.25) +
  stat_summary(fun="median", geom="crossbar", size=0.5, fill="red", color = "blue") +
  stat_summary(fun="cimed", geom="crossbar", size=0.5, fill="red", color = "red") +

  #theme(axis.text.x = element_text(angle = 45, vjust = 0.6),
  #      axis.title.x=element_blank(),
  #      axis.title.y=element_blank()) +
  
  theme(axis.text.x = element_text(angle = 45, vjust = 0.6),
        axis.title.x=element_blank()) +
  
  
  labs(x=expression(paste("")), y=expression(paste(d[1] / d[1]+d[2]))) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))
```

## Figure 5D

Plotted are the relative anterior (A) and posterior (P) areas for males and females of the tested $\textit{Drosophila}$ species.

```{r Figure_5D}
plot_widths = 5.75
plot_heights = 3.25
plot_order = c("DMF","DMM","DSF","DSM","DAF","DAM","DVF","DVM")
#svg("Total_Area.svg", width = plot_widths, height = plot_heights, family="arial")

ggplot(grouped_by_species %>% dplyr::filter(Metric=="P_to_A"),
       aes(x=factor(Species_Gender, ordered=TRUE, levels = plot_order),
           y=Measure,
           fill=Gender)) +
  geom_violin(scale="width", alpha=0.50) +
  geom_jitter(width=0.25) +
  stat_summary(fun="median", geom="crossbar", size=0.5, fill="red", color = "blue") +
  stat_summary(fun="cimed", geom="crossbar", size=0.5, fill="red", color = "red") +

  #theme(axis.text.x = element_text(angle = 45, vjust = 0.6),
  #      axis.title.x=element_blank(),
  #      axis.title.y=element_blank()) +
  
  theme(axis.text.x = element_text(angle = 45, vjust = 0.6),
        axis.title.x=element_blank()) +
  
  
  labs(x=expression(paste("")), y=expression(paste("Area (P) / Area (A)"))) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))
```

## Figure 5D Anterior Only

Plotted are the anterior areas for males and females (in $mm^2$) of the tested $\textit{Drosophila}$ species.

```{r Figure_5D_Anterior}
plot_widths = 5.75
plot_heights = 3.25
plot_order = c("DMF","DMM","DSF","DSM","DAF","DAM","DVF","DVM")
#svg("Total_Area.svg", width = plot_widths, height = plot_heights, family="arial")

ggplot(grouped_by_species %>% dplyr::filter(Metric=="Anterior_Area"),
       aes(x=factor(Species_Gender, ordered=TRUE, levels = plot_order),
           y=Measure,
           fill=Gender)) +
  geom_violin(scale="width", alpha=0.50) +
  geom_jitter(width=0.25) +
  stat_summary(fun="median", geom="crossbar", size=0.5, fill="red", color = "blue") +
  stat_summary(fun="cimed", geom="crossbar", size=0.5, fill="red", color = "red") +

  #theme(axis.text.x = element_text(angle = 45, vjust = 0.6),
  #      axis.title.x=element_blank(),
  #      axis.title.y=element_blank()) +
  
  theme(axis.text.x = element_text(angle = 45, vjust = 0.6),
        axis.title.x=element_blank()) +
  
  
  labs(x=expression(paste("")), y=expression(paste("Anterior area " (mm^2)))) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))
```

## Figure 5D Posterior Only

Plotted are the posterior areas for males and females (in $mm^2$) of the tested $\textit{Drosophila}$ species.

```{r Figure_5D_Posterior}
plot_widths = 5.75
plot_heights = 3.25
plot_order = c("DMF","DMM","DSF","DSM","DAF","DAM","DVF","DVM")
#svg("Total_Area.svg", width = plot_widths, height = plot_heights, family="arial")

ggplot(grouped_by_species %>% dplyr::filter(Metric=="Posterior_Area"),
       aes(x=factor(Species_Gender, ordered=TRUE, levels = plot_order),
           y=Measure,
           fill=Gender)) +
  geom_violin(scale="width", alpha=0.50) +
  geom_jitter(width=0.25) +
  stat_summary(fun="median", geom="crossbar", size=0.5, fill="red", color = "blue") +
  stat_summary(fun="cimed", geom="crossbar", size=0.5, fill="red", color = "red") +

  #theme(axis.text.x = element_text(angle = 45, vjust = 0.6),
  #      axis.title.x=element_blank(),
  #      axis.title.y=element_blank()) +
  
  theme(axis.text.x = element_text(angle = 45, vjust = 0.6),
        axis.title.x=element_blank()) +
  
  
  labs(x=expression(paste("")), y=expression(paste("Posterior area " (mm^2)))) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))
```

## Figure 5E

Plotted are the scaling relationships between the length of the proximal-distal (l(P-D)) axis and the square root overall wing blade area for males and females of the tested $\textit{Drosophila}$ species.

```{r Figure_5E}
plot_widths = 5.75
plot_heights = 3.25
plot_order = c("DMF","DMM","DSF","DSM","DAF","DAM","DVF","DVM")
#svg("Total_Area.svg", width = plot_widths, height = plot_heights, family="arial")

PD_Only = grouped_by_species%>%dplyr::filter(Metric=="PD")
Area_Only = grouped_by_species%>%dplyr::filter(Metric=="Area")

ggplot(Area_Only,
       aes(x=factor(Species_Gender, ordered=TRUE, levels = plot_order),
           y=PD_Only$Measure / sqrt(Area_Only$Measure),
           fill=Gender)) +
  geom_violin(scale="width", alpha=0.50) +
  geom_jitter(width=0.25) +
  stat_summary(fun="median", geom="crossbar", size=0.5, fill="red", color = "blue") +
  stat_summary(fun="cimed", geom="crossbar", size=0.5, fill="red", color = "red") +

  #theme(axis.text.x = element_text(angle = 45, vjust = 0.6),
  #      axis.title.x=element_blank(),
  #      axis.title.y=element_blank()) +
  
  theme(axis.text.x = element_text(angle = 45, vjust = 0.6),
        axis.title.x=element_blank()) +
  
  
  labs(x=expression(paste("")), y=expression(paste("l(P-D) / sqrt(Area)"))) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))
```

## Figure 5F

Plotted are the scaling relationships between the length of the proximal-distal (l(A-P)) axis and the square root overall wing blade area for males and females of the tested $\textit{Drosophila}$ species. **OUTLIER NEEDS TO BE ADDRESSED**

```{r Figure_5F}
plot_widths = 5.75
plot_heights = 3.25
plot_order = c("DMF","DMM","DSF","DSM","DAF","DAM","DVF","DVM")
#svg("Total_Area.svg", width = plot_widths, height = plot_heights, family="arial")

AP_Only = grouped_by_species%>%dplyr::filter(Metric=="AP")
Area_Only = grouped_by_species%>%dplyr::filter(Metric=="Area")

ggplot(Area_Only,
       aes(x=factor(Species_Gender, ordered=TRUE, levels = plot_order),
           y=AP_Only$Measure / sqrt(Area_Only$Measure),
           fill=Gender)) +
  geom_violin(scale="width", alpha=0.50) +
  geom_jitter(width=0.25) +
  stat_summary(fun="median", geom="crossbar", size=0.5, fill="red", color = "blue") +
  stat_summary(fun="cimed", geom="crossbar", size=0.5, fill="red", color = "red") +

  #theme(axis.text.x = element_text(angle = 45, vjust = 0.6),
  #      axis.title.x=element_blank(),
  #      axis.title.y=element_blank()) +
  
  theme(axis.text.x = element_text(angle = 45, vjust = 0.6),
        axis.title.x=element_blank()) +
  
  
  labs(x=expression(paste("")), y=expression(paste("l(A-P) / sqrt(Area)"))) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))
```

## Figure 5G

Plotted are the l(P-D) to l(A-P) ratio for males and females of the tested $\textit{Drosophila}$ species. **OUTLIER NEEDS TO BE ADDRESSED**

```{r Figure_5G}
plot_widths = 5.75
plot_heights = 3.25
plot_order = c("DMF","DMM","DSF","DSM","DAF","DAM","DVF","DVM")
#svg("Total_Area.svg", width = plot_widths, height = plot_heights, family="arial")

ggplot(Area_Only,
       aes(x=factor(Species_Gender, ordered=TRUE, levels = plot_order),
           y=PD_Only$Measure / AP_Only$Measure,
           fill=Gender)) +
  geom_violin(scale="width", alpha=0.50) +
  geom_jitter(width=0.25) +
  stat_summary(fun="median", geom="crossbar", size=0.5, fill="red", color = "blue") +
  stat_summary(fun="cimed", geom="crossbar", size=0.5, fill="red", color = "red") +

  #theme(axis.text.x = element_text(angle = 45, vjust = 0.6),
  #      axis.title.x=element_blank(),
  #      axis.title.y=element_blank()) +
  
  theme(axis.text.x = element_text(angle = 45, vjust = 0.6),
        axis.title.x=element_blank()) +
  
  
  labs(x=expression(paste("")), y=expression(paste("l(P-D) / l(A-P)"))) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))
```

## Figure 5H

**NEED TO OBTAIN MISSING DATA FROM NILAY**

# Manual versus automated measurements of wing area and landmark positions

## Load second dataset

Load the CSV file containing the data.

```{r dataLoading_two, message=FALSE, warning=FALSE, error=FALSE}
dataset_df_comparison = read.csv("MAPPER_Manual_VS_Automated.csv", header=T, sep=",", fileEncoding="UTF-8-BOM") %>% tibble()
dataset_df_comparison
```

## Ensure no mismatches names/labels in files

Here, the file names of manual measurements are compared to automated measurements and check for any labelling mismatches. A value of zero returned indicates no mismatches.

```{r sanityCheck}
sum(dataset_df_comparison$Manual_File != dataset_df_comparison$Auto_File)
```

## Plot the areas

Plotted are the total wing areas of male Samarkand species $\textit{Drosophila}$ that were measured manually and by MAPPER. The two are plotted against each other to demonstrate a 1:1 correlation. **UNITS NEED TO BE FIXED**

```{r Figure_4E}
plot_widths = 5.75
plot_heights = 3.25
#svg("Total_Area.svg", width = plot_widths, height = plot_heights, family="arial")

linear_fit = lm(dataset_df_comparison$Auto_Area~dataset_df_comparison$Manual_Area)
ggplot(dataset_df_comparison,
       aes(x=Manual_Area,
           y=Auto_Area)) +
  geom_point() +
  stat_smooth(method = "lm", col = "red", formula = y~x) +
  labs(x=expression(paste(Area[MANUAL] (units^2))), 
       y=expression(paste(Area[MAPPER] (units^2))),
       title = paste("Adj R2 = ",signif(summary(linear_fit)$adj.r.squared, 5),
                     " Intercept =",signif(linear_fit$coef[[1]],5 ),
                     " Slope =",signif(linear_fit$coef[[2]], 5),
                     " P =",signif(summary(linear_fit)$coef[2,4], 5))) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))
```


The summary statistics of the linear fit are shown below:

```{r checkLinearFit_Area}
summary(linear_fit)
```

## Plot the l(P-D)

Plotted are the lengths of the proximal-distal (l(P-D)) axes for male Samarkand species $\textit{Drosophila}$ that were measured manually and by MAPPER. The two are plotted against each other to demonstrate a 1:1 correlation. **UNITS NEED TO BE FIXED AND THERE IS A NOTALBE MISMATCH**

```{r Figure_4E_PD}
plot_widths = 5.75
plot_heights = 3.25
#svg("Total_Area.svg", width = plot_widths, height = plot_heights, family="arial")

linear_fit = lm(dataset_df_comparison$Auto_PD~dataset_df_comparison$Manual_PD)
ggplot(dataset_df_comparison,
       aes(x=Manual_PD,
           y=Auto_PD)) +
  geom_point() +
  stat_smooth(method = "lm", col = "red", formula = y~x) +
  labs(x=expression(paste(P-D[MANUAL] (units))), 
       y=expression(paste(P-D[MAPPER] (units))),
       title = paste("Adj R2 = ",signif(summary(linear_fit)$adj.r.squared, 5),
                     " Intercept =",signif(linear_fit$coef[[1]],5 ),
                     " Slope =",signif(linear_fit$coef[[2]], 5),
                     " P =",signif(summary(linear_fit)$coef[2,4], 5))) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))
```

The summary statistics of the linear fit are shown below:

```{r checkLinearFit_PD}
summary(linear_fit)
```

## Plot the l(A-P)

Plotted are the lengths of the proximal-distal (l(A-P)) axes for male Samarkand species $\textit{Drosophila}$ that were measured manually and by MAPPER. The two are plotted against each other to demonstrate a 1:1 correlation. **UNITS NEED TO BE FIXED AND THERE IS A NOTALBE MISMATCH**

```{r Figure_4E_AP}
plot_widths = 5.75
plot_heights = 3.25
#svg("Total_Area.svg", width = plot_widths, height = plot_heights, family="arial")

linear_fit = lm(dataset_df_comparison$Auto_AP~dataset_df_comparison$Manual_AP)
ggplot(dataset_df_comparison,
       aes(x=Manual_AP,
           y=Auto_AP)) +
  geom_point() +
  stat_smooth(method = "lm", col = "red", formula = y~x) +
  labs(x=expression(paste(A-P[MANUAL] (units))), 
       y=expression(paste(A-P[MAPPER] (units))),
       title = paste("Adj R2 = ",signif(summary(linear_fit)$adj.r.squared, 5),
                     " Intercept =",signif(linear_fit$coef[[1]],5 ),
                     " Slope =",signif(linear_fit$coef[[2]], 5),
                     " P =",signif(summary(linear_fit)$coef[2,4], 5))) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))
```

The summary statistics of the linear fit are shown below:

```{r checkLinearFit_AP}
summary(linear_fit)
```

# **TO DO:**
- Fix units for plots of Figure 4
- Obtain L3-L4 area measurements for Figure 5 panel H
- Address the outlier in Figure 5F and 5G
- Provide statistical comparisons of groups
- Have table of p-value comparisons




















